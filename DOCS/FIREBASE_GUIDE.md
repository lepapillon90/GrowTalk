# 🔥 Firestore 비용 최적화 및 운영 가이드 (GrowTalk)

이 문서는 GrowTalk 앱의 Firebase 아키텍처, 비용 절감 전략, 그리고 향후 개발 방향성을 정리한 가이드입니다.
초기 스타트업 단계에서 **안정성**과 **비용 효율성**을 모두 잡기 위한 설계를 포함합니다.

---

## 🏗 1. 전체 아키텍처 (Current Status)

GrowTalk는 Firebase의 핵심 5대 기능을 사용하여 Serverless 아키텍처로 구축되었습니다.

| 구성 요소 | 역할 | GrowTalk 현황 |
| :--- | :--- | :--- |
| **Authentication** | 로그인/회원가입 | ✅ 구현 완료 (이메일/구글, 카카오 예정) |
| **Firestore** | DB (채팅, 유저 데이터) | ✅ 구현 완료 (`users`, `chats`, `messages`) |
| **Storage** | 이미지 업로드 | ✅ 구현 완료 (프로필, 채팅 이미지) |
| **Functions** | 서버 로직 (푸시 등) | ⬜ **미구현 (향후 도입 필요)** |
| **FCM** | 푸시 알림 | ⬜ **미구현 (향후 도입 필요)** |

---

## 📂 2. Firestore 데이터 구조 설계

비용 절감의 핵심은 **"필요한 데이터만 읽는 것"**입니다. GrowTalk는 이미 권장 구조와 유사한 최적화된 스키마를 사용 중입니다.

### ✅ 권장 구조 vs GrowTalk 구조

**권장 구조:**
```
rooms/{roomId}/messages/{messageId} (Sub-collection)
```
**GrowTalk 구조:**
```
chats/{chatId}/messages/{messageId} (Sub-collection)
```
👉 **결론:** 이미 **Sub-collection 패턴**을 사용하고 있어, 채팅방 목록을 불러올 때 메시지까지 모두 읽어오는 낭비가 없습니다. 
또한 채팅방 문서(`chats/{id}`)에 `lastMessage` 필드를 두어 목록 조회 시 메시지 하위 컬렉션을 읽지 않아도 되도록 최적화되어 있습니다.

---

## 📉 3. 읽기(Read) 비용 최적화 전략 (핵심 과제)

Firestore 비용의 80%는 "읽기(Read)"에서 발생합니다. 현재 GrowTalk에서 **가장 시급히 적용해야 할 최적화** 포인트입니다.

### 🔴 1) 메시지 페이지네이션 (Pagination) - [TODO]
*   **현재:** 채팅방 입장 시 메시지를 전부(혹은 쿼리 제한 없이) 리스닝할 수 있음.
*   **개선:** `limit(20)`과 `startAfter`를 사용하여 **최근 20개만** 가져오고, 스크롤을 올릴 때 이전 메시지를 로드해야 합니다.
    ```javascript
    // 예시 쿼리
    messagesRef.orderBy('createdAt', 'desc').limit(20);
    ```
*   **효과:** 사용자 1,000명 기준 월 비용을 수십 달러 인하 가능.

### 🔵 2) 실시간 리스너 최적화
*   **현재:** `onSnapshot`을 사용하여 실시간성을 보장 중.
*   **전략:** 채팅방 목록이나 메시지 목록은 실시간이 필수지만, 친구 목록 등 갱신 빈도가 낮은 데이터는 `get()`을 적절히 혼용하거나 로컬 캐싱을 고려해야 합니다.

---

## 🖼 4. Storage 비용 및 이미지 최적화

### ✅ GrowTalk의 강점: 클라이언트 압축
일반적인 가이드는 "서버(Cloud Functions)에서 이미지 썸네일 생성"을 권장하지만, 이는 컴퓨팅 비용이 발생합니다.
**GrowTalk는 `browser-image-compression` 라이브러리를 도입하여 업로드 전 브라우저에서 이미지를 압축합니다.**
*   **장점:** 서버 컴퓨팅 비용 **0원**. 업로드 속도 향상. Storage 용량 절약.

### 💡 추가 전략
*   **오래된 파일 삭제:** 추후 Cloud Functions의 스케줄러(Cron)를 이용하여 오래된 채팅 이미지를 자동 삭제하는 정책 고려 가능.

---

## 🔔 5. 푸시 알림 (FCM) 설계 [TODO]

FCM 메시지 발송 자체는 **무료**입니다. 다만, 언제 발송하느냐가 중요합니다.

### 구현 로직 (예상)
1.  사용자가 채팅 메시지 전송 (`Firestore` 쓰기 발생)
2.  `Cloud Functions` 트리거 (`onCreate`)
3.  상대방의 FCM 토큰 조회
4.  FCM 전송

*주의: 채팅이 활발한 단톡방의 경우 알림이 폭주할 수 있으므로, 클라이언트/서버에서 알림 모으기(Throttle) 처리가 필요할 수 있습니다.*

---

## 📊 6. 예상 운영 비용 (월간 활성 사용자 1,000명 기준)

| 항목 | 예상 비용 | 비고 |
| :--- | :--- | :--- |
| **Firestore** | ₩5,000 ~ 20,000 | 페이지네이션 미적용 시 폭증 가능 |
| **Storage** | ₩1,000 ~ 5,000 | 클라이언트 압축으로 매우 저렴 |
| **Authentication** | 무료 | 전화번호 인증 제외 시 무료 |
| **Hosting** | 무료 ~ 소액 | Vercel Hobby 등 활용 시 무료 |
| **합계** | **약 ₩10,000 ~ 25,000** | 커피 몇 잔 값으로 운영 가능 |

---

## 📌 7. 단계별 개발 로드맵 (Action Items)

### 🔥 Phase 1: 필수 최적화 (현재 단계)
- [x] Firestore 기본 구조 (Sub-collection) 적용
- [x] 채팅방 목록 최적화 (`lastMessage` 필드 사용)
- [x] 클라이언트 측 이미지 압축 도입
- [ ] **메시지 페이지네이션 (`limit`) 적용** (최우선 순위)
- [ ] **실시간 리스너 최적화** (최우선 순위)
- [ ] **메시지 삭제** (최우선 순위)
- [ ] **메시지 수정** (최우선 순위)
- [ ] **메시지 읽음 표시** (최우선 순위)

### 🚀 Phase 2: 기능 확장
- [ ] FCM 푸시 알림 구현
- [ ] 카카오 로그인 연동

### 🛡 Phase 3: 운영 자동화
- [ ] 신고/차단 기능
- [ ] 오래된 데이터/이미지 자동 삭제 스크립트
